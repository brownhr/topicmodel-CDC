---
output: pdf_document
---

```{r setup, include = F}

library(dplyr)
library(readr)
library(stringr)
library(textmineR)
library(SnowballC)

# Read reply tweets from RDS file

reply_tweets <- read_rds("data/reply_tweets.Rds")


# Create some Twitter stopwords

twitter_stopwords <- c("amp", "rt", "co", "t", "cdcgov")


# Create a directory for models
model_dir <- "models/reply"
if (!dir.exists("models/reply")) {
    dir.create(file.path(getwd(), model_dir), recursive = T)
}


# Load the (sample) DTM from rds, if it exists
if (file.exists("data/reply_dtm_sample.Rds")) {
    reply_dtm_sample <- read_rds("data/reply_dtm_sample.Rds")
}
```

```{r sample-reply, eval = F}
reply_tweets_sample <- reply_tweets %>%
    slice_sample(prop = 0.2)
```

```{r reply-dtm-sample, eval = F}
source("createDTM.R")

if (!file.exists("data/reply_dtm_sample.Rds")) {
    reply_dtm_sample <- create_dtm(
        doc_vec = reply_tweets_sample$text,
        doc_names = reply_tweets_sample$tweet_id
    )
    write_rds(reply_dtm_sample, "data/reply_dtm_sample.Rds")
}
```

```{r calc-lda-k, eval = F}
source("createLDA.R")

# Define a directory for LDA models...


k_list <- seq(2, 100, 1)

k_list <- TmParallelApply(
    X = k_list,
    FUN = function(K) {
        filename <- paste0(model_dir, "/", K, "_model.Rds")

        if (!file.exists(filename)) {
            lda <- cast_lda(
                dtm = reply_dtm_sample,
                k = K,
            )
            write_rds(lda, file = filename)
        } else {
            lda <- read_rds(filename)
        }

        coherence <- lda$coherence
        return(coherence)
    },
    export = c("k_list", "cast_lda", "reply_dtm_sample", "model_dir"),
    cpus = (parallel::detectCores() - 2)
)
```

```{r CTM-init, eval = F}
# If we choose to run a CTM, put it here
```