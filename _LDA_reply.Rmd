---
output: pdf_document
---

```{r setup, include = F}

library(dplyr)
library(readr)
library(stringr)
library(textmineR)
library(SnowballC)

# Read reply tweets from RDS file

reply_tweets <- read_rds("data/reply_tweets.Rds")


# Create some Twitter stopwords

twitter_stopwords <- c("amp", "rt", "co", "t", "cdcgov")


# Create a directory for models
model_dir <- "models/reply"
if (!dir.exists("models/reply")) {
    dir.create(file.path(getwd(), model_dir), recursive = T)
}


# Load the (sample) DTM from rds, if it exists
if (file.exists("data/reply_dtm_sample.Rds")) {
    reply_dtm_sample <- read_rds("data/reply_dtm_sample.Rds")
}
```

```{r sample-reply, eval = F}
reply_tweets_sample <- reply_tweets %>%
    slice_sample(prop = 0.2)
```

```{r reply-dtm-sample, eval = F}
source("createDTM.R")

if (!file.exists("data/reply_dtm_sample.Rds")) {
    reply_dtm_sample <- create_dtm(
        doc_vec = reply_tweets_sample$text,
        doc_names = reply_tweets_sample$tweet_id
    )
    write_rds(reply_dtm_sample, "data/reply_dtm_sample.Rds")
}
```

```{r calc-lda-k, eval = F}
# source("createLDA.R")

# Define a directory for LDA models...


k_list <- seq(2, 50, 1)

lda_list <- TmParallelApply(
    X = k_list,
    FUN = function(k) {
        filename = file.path(model_dir, paste0(k, ".rda"))
        if (!file.exists(filename)) {
            lda <- textmineR::FitLdaModel(
                dtm = reply_dtm_sample,
                k = k,
                alpha = 0.1,
                beta = 0.05,
                calc_coherence = TRUE,
                cpus = 1
            )
            lda$k <- k
            save(lda, file = filename)
        } else {
            load(filename)
        }

        coherence <- mean(lda$coherence)
        rm(lda)
        return(coherence)
    },
    export = c("reply_dtm_sample"),
    cpus = 10
)
```

```{r CTM-init, eval = F}
# If we choose to run a CTM, put it here
```